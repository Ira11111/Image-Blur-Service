# Image-Blur-Service

Это веб-сервис для обработки изображений. Работа с файлами зачастую - это долгий процесс,
и его выполнение может блокировать основное приложение. 
Чтобы этого избежать, задачи, отнимающие большое количество времени,
необходимо выполнять асинхронно. 

Для этого в данном приложении используется очередь задач,
которая позволяет отделить длительные и ресурсоёмкие операции от основного потока
выполнения приложения, а также планировать выполнение определенных процессов.

В данном приложении для реализации очереди задач используется готовый инструмент Celery.
Для планирования задач используется Celery Beat.


## Сценарий использования:
1. Пользователь заполняет форму, где указывает свой email и изображения, 
которые необходимо обработать
2. Пользователь по id заказа, может просматривать статус своего заказа на обработку
3. Пользователь переходит по ссылке, где запрашивает отправку письма
на свой email с готовыми изображениями
4. Также пользователь может подписаться на еженедельную рассылку от сервиса или отписаться от нее


## Endpoints приложения:

- **POST /blur** <br>
Ставит в очередь обработку переданных изображений. Возвращает ID группы задач по обработке изображений.
- **GET /status/<group_id>>**<br>
Возвращает информацию о задаче: прогресс (количество обработанных задач) и статус (в процессе обработки, обработано).
- **GET /send_images/<group_id>>**<br>
Отправляет на электронную почту пользователя архив с обработанными изображениями.
- **POST /subscribe**<br>
Пользователь указывает почту и подписывается на рассылку. Каждую неделю ему будет приходить письмо о сервисе на почту.
- **POST /unsubscribe**<br>
Пользователь указывает почту и отписывается от рассылки.


## Инструкция по запуску
1. Установите зависимости
```bash
pip install -r requirements.txt
```
2. Создайте файл .env и пометите в него необходимые переменные среды.
Ориентироваться можно на файл env.templates

3. Для работы celery используется брокер redis. 
Один из вариантов запуска - стянуть образ redis из docker-hub
и запустить контейнер в фоновом режиме. 
```bash
docker run -p6379:6379 --name my-redis -p6379:6379 -d redis
```

4. Для запуска celery из папки application проекта нужно выполнить команду
```bash
celery -A tasks worker
celery -A tasks beat
```

5. Приложение готово к запуску. Откройте файл app.py и запустите приложение. 
Либо выполните команду из терминала
```bash
python application/app.py
```

6. Для мониторинга задач в очереди, можно воспользоваться инструментом flower.
Для этого нужно выполнить комаду
```bash
celery -A tasks flower
```
После чего на порту 5555 запуститься приложение для просмотра задач.
